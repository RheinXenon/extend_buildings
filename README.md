# 建筑扩展模组 (Extended Buildings Mod)

## 简介

为《欧陆风云5》添加两个新建筑类型，丰富游戏的城市发展和人口管理策略。

## 包含的建筑

### 1. 居民署 (Resident Office)

提供基础行政管理服务，通过三级建筑升级系统提供递增的人口增长效果。

**建筑特性**:
- **建造条件**: 地区人口比例 < 60%
- **最大等级**: 3级（固定）
- **类型**: 基础设施建筑（农民工作）
- **解锁条件**: 所有等级游戏开始即可用
- **适用范围**: 农村聚落、集镇、城市

**建筑等级对比**:

| 建筑等级               | 资源消耗                    | 效果                   | 说明     |
| ---------------------- | --------------------------- | ---------------------- | -------------- |
| **一级：基础居民服务** | 木材0.1, 工具0.1, 布料0.1   | +0.5%人口增长, +3%疾病抗性 | 基础行政管理服务 |
| **二级：改进居民服务** | 木材0.2, 工具0.2, 布料0.2  | +0.7%人口增长, +6%疾病抗性 | 改进的公共服务 |
| **三级：高级人口管理** | 木材0.3, 工具0.3, 布料0.3 | +0.9%人口增长, +9%疾病抗性 | 全面的人口管理 |

---

### 2. 城乡结合部 (Urban-Rural Junction)

扩展城市建筑容量的基础设施建筑，通过增加可用建筑等级来支持更多建筑建设。

**建筑特性**:
- **最大等级**: 动态计算（基于发展度和人口）
- **类型**: 基础设施建筑（农民工作）
- **解锁条件**: 游戏开始即可用
- **适用范围**: 仅限城市和集镇（不适用于农村聚落）

**主要效果**:
- **可用建筑等级**: 每级 +10
- **资源消耗**: 每级消耗砖石0.1、工具0.1

**上限计算公式**:
```
最大等级 = 1 + (发展度 × 0.1) + (人口 × 0.05)
```

**计算示例**:
- 发展度10，人口100：最大7级
- 发展度20，人口200：最大13级

## 安装方法

1. 复制 `extend_buildings` 文件夹到：
   ```
   Documents/Paradox Interactive/Europa Universalis V/mod/
   ```
2. 在游戏mod管理器中启用

---

## 重要技术说明

### EU5建筑等级机制

✅ **核心原理**: 

1. **居民署**: 使用固定三级建筑系统（`max_levels = 3`）
   - 使用 `raw_modifier`（固定值）+ `modifier`（按等级缩放）组合
   - 实现递增但非线性的效果（0.5%/0.7%/0.9%人口增长）

2. **城乡结合部**: 使用动态等级计算（`max_levels` 块）
   - 基于发展度和人口动态计算上限
   - 使用 `free_building_levels` 增加可用建筑等级

### 为什么不用生产方式切换？

- **EU5限制**: 生产方式不支持modifier效果，只能定义资源输入/输出
- **解决方案**: 使用建筑等级系统，效果定义在建筑本身
- **自动缩放**: 资源消耗和modifier效果自动随建筑等级线性增长

### 关键技术点

1. **free_building_levels vs local_building_slots**
   - 正确使用 `free_building_levels` 而非 `local_building_slots`

2. **masonry vs bricks**
   - 使用 `masonry`（砖石）而非 `bricks`，符合EU5资源命名

3. **动态max_levels**
   - 使用 `max_levels` 块而非 `max_level_at_location`
   - 支持更复杂的计算公式

4. **即时可用**
   - 所有建筑等级游戏开始就解锁，无需科技或进度要求

### 测试步骤

**居民署**:
1. 在人口比例 < 60% 的地区建造居民署（一级）
2. 升级到二级或三级
3. 检查人口增长率和疾病抗性数值变化
4. 验证资源消耗是否随等级递增（0.3/0.6/0.9总消耗）

**城乡结合部**:
1. 在城市或集镇建造城乡结合部
2. 验证可用建筑等级确实增加
3. 测试不同发展度和人口时的最大等级
4. 检查资源消耗是否正确缩放

### 文件结构

```
extend_buildings/
├── in_game/
│   ├── common/
│   │   ├── building_types/
│   │   │   ├── resident_office.txt
│   │   │   └── urban_rural_junction.txt
│   │   └── production_methods/
│   │       ├── resident_office_production_methods.txt
│   │       └── urban_rural_junction_production_methods.txt
│   └── gfx/interface/icons/buildings/
│       ├── resident_office.dds
│       └── urban_rural_junction.dds
├── main_menu/localization/
│   ├── english/
│   │   ├── resident_office_l_english.yml
│   │   └── urban_rural_junction_l_english.yml
│   └── simp_chinese/
│       ├── resident_office_l_simp_chinese.yml
│       └── urban_rural_junction_l_simp_chinese.yml
└── docs/
    ├── 居民署建筑设计.md
    └── 城乡结合部建筑设计.md
```

## 版本历史

- **v4.0.0** (2025-11-10) - 添加城乡结合部建筑，完善文档
- **v3.0.0** (2025-11-10) - 居民署改用三级建筑升级系统
- **v2.0.0** (2025-11-10) - 三种生产方式系统（已废弃）
- **v1.0.1** (2025-11-10) - 修复本地化UTF-8 with BOM编码
- **v1.0.0** (2025-11-10) - 初始版本

## 兼容性

- **游戏版本**: Europa Universalis V 1.0.*
- **文件覆盖**: 不覆盖任何原版文件
- **本地化编码**: UTF-8 with BOM
- **与其他MOD**: 应该兼容大多数MOD，除非修改相同的建筑系统

## 详细文档

- [居民署建筑设计](docs/居民署建筑设计.md) - 详细的设计理念和实现说明
- [城乡结合部建筑设计](docs/城乡结合部建筑设计.md) - 详细的设计理念和实现说明
